<!-- index.ejs -->
<%
const canSeeDetails = user.ismember || user.isadmin;
const canManageUsers = user.isadmin;
%>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Chatroom</title>
    <style>
        /* Style the modal */
        dialog {
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            width: 600px;
            max-width: 90%;
        }
        
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>Chatroom</h1>
    
  <% if (messages && messages.length > 0) { %>
    <ul style='list-style-type: none'>
      <% messages.forEach(msg => { %>
        <li style="<%= msg.username === user.username ? 'text-align: right;' : 'text-align: left; background-color: #fff;' %>">
            <% if (msg.canEdit) { %>
                <a href="/messages/<%= msg.id %>/edit">Edit</a>
            <% } %>

            <% if (msg.canDelete) { %>
                <form method="POST" action="/messages/<%= msg.id %>/delete" style="display:inline;">
                    <button>Delete</button>
                </form>
            <% } %>
          <% if (user.ismember||msg.user_id===user.id||user.isadmin) { %>
            <strong><%= msg.username %>:</strong> 
          <% } else { %>  
            <strong>Anonymous</strong> 
          <% } %>
          <%= msg.message %> 
          (<%= new Date(msg.created_at).toLocaleString() %>)<br>
          <!-- <% if (user.isadmin|| msg.user_id === user.id) { %> -->
          <!--     <% if (msg.ismember) { %> -->
          <!--       <form method="POST" action="/demoteMember"> -->
          <!--           <input type="hidden" name="user_id" value="<%= msg.user_id %>"> -->
          <!--           <button type="submit" class="demoteMember-btn">cancel their membership</button> -->
          <!--       </form> -->
          <!--     <% } else { %>   -->
          <!--       <form method="POST" action="/becomeMember"> -->
          <!--           <input type="hidden" name="user_id" value="<%= msg.user_id %>"> -->
          <!--           <button type="submit" class="makethemmember-btn">make them member</button> -->
          <!--       </form> -->
          <!--     <% } %> -->
          <!-- <% } %> -->
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p>No messages found.</p>
  <% } %>
  <form method="POST" action="/becomeMember">
    <button type="submit" class="becomeMember-btn">become member</button>
  </form>
  <form method="POST" action="/logout">
    <button type="submit" class="logout-btn">logout</button>
  </form>
    <form method="POST" action="/messages">
        <textarea name="message" placeholder="Type your message..."></textarea>
        <button type="submit">Send</button>
    </form>
    <ul>
        <% messages.forEach(msg => { %>
        <% }) %>
    </ul>
    
        <button onclick="openUserModal()">ðŸ‘¥ Users list</button>
    <!-- User management modal -->
    <% if (user) { %>
        <dialog id="userModal">
            <h2>User Management</h2>
            
<table>
    <thead>
        <tr>
            <th>Username</th>
            <% if (canSeeDetails) { %>
                <th>Status</th>
                <th>Messages</th>
            <% } %>
            <% if (canManageUsers) { %>
                <th>membership management</th>
                <th>kick it!</th>
            <% } %>
        </tr>
    </thead>
    <tbody>
        <% allUsers.forEach(u => { %>
            <%
            // Calculate per-user permissions
            const showRealName = canSeeDetails || u.id === user.id;
            const canModifyThisUser = canManageUsers && !u.isadmin && u.id !== user.id;
            %>
            
            <tr>
                <td><%= showRealName ? u.username : 'Anonymous' %></td>
                
                <% if (canSeeDetails) { %>
                    <td>
                        <% if (u.isadmin) { %>Admin
                        <% } else if (u.ismember) { %>Member
                        <% } else { %>User<% } %>
                    </td>
                    <td><%= u.message_count %></td>
                <% } %>
                
                <% if (canManageUsers) { %>
                    <td>
                        <% if (canModifyThisUser) { %>
                            <% if (u.ismember) { %>
                                <form method="POST" action="/users/<%= u.id %>/demote" style="display: inline;">
                                    <button>Demote</button>
                                </form>
                            <% } else { %>
                                <form method="POST" action="/users/<%= u.id %>/promote" style="display: inline;">
                                    <button>Promote</button>
                                </form>
                            <% } %>
                        <% } else if (u.id === user.id) { %>
                            your admin!
                        <% } else { %>
                            -
                        <% } %>
                    </td>
                <% } %>
                <% if (canManageUsers && !u.isadmin && u.id !== user.id) { %>
                    <td>
                        <form method="POST" action="/users/<%= u.id %>/kick" style="display: inline;"
                              onsubmit="return confirm('Are you sure you want to kick <%= u.username %>?')">
                            <button type="submit" style="color: red;">ðŸš« Kick</button>
                        </form>
                    </td>
                <% } %>
            </tr>
        <% }) %>
    </tbody>
</table>
            
            <button onclick="closeUserModal()" style="margin-top: 10px;">Close</button>
        </dialog>
    <% } %>
    
    <!-- Your existing forms (logout, message, etc) -->
    
<script>
//we can do this stugg with ajax too(mybe later) 
    function openUserModal() {
        document.getElementById('userModal').showModal();
    }
    
    function closeUserModal() {
        document.getElementById('userModal').close();
        // Clean up URL hash
        history.pushState("", document.title, window.location.pathname);
    }
    
    // Auto-open modal if hash is present
    window.addEventListener('DOMContentLoaded', function() {
        if (window.location.hash === '#open-users-modal') {
            openUserModal();
            // Optional: clean up hash
            history.replaceState(null, null, ' ');
        }
    });
</script>
</body>
</html>
