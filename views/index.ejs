<%
const canSeeDetails = user.ismember || user.isadmin;
const canManageUsers = user.isadmin;
%>
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatroom</title>
    <!-- Pico CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        /* Custom overrides */
        .message-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: var(--pico-border-radius);
            background: var(--pico-card-background-color);
        }
        
        .message-item.own-message {
            background: var(--pico-primary-background);
            margin-left: 2rem;
        }
        
        .message-actions {
            display: inline-flex;
            gap: 0.5rem;
            margin-left: 0.5rem;
        }
        
        .message-actions button,
        .message-actions form {
            display: inline;
        }
        
        .message-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin: 0;
        }
        
        .message-meta {
            color: var(--pico-muted-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        dialog {
            max-width: 600px;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <main class="container">
        <hgroup>
            <h1>üí¨ Chatroom</h1>
            <p>Welcome, <strong><%= user.username %></strong>! 
                <% if (user.isadmin) { %>
                    <span role="button" style="--pico-color: var(--pico-del-color); display: inline; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Admin</span>
                <% } else if (user.ismember) { %>
                    <span role="button" style="--pico-color: var(--pico-ins-color); display: inline; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Member</span>
                <% } %>
            </p>
        </hgroup>
        
        <!-- Flash Messages -->
        <% if (messages.error) { %>
            <article style="--pico-color: var(--pico-del-color);">
                <%= messages.error %>
            </article>
        <% } %>
        <% if (messages.success) { %>
            <article style="--pico-color: var(--pico-ins-color);">
                <%= messages.success %>
            </article>
        <% } %>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button onclick="openUserModal()" class="outline">üë• Users</button>
            <% if (user && !user.ismember) { %>
                <button onclick="openMemberModal()" class="outline">‚≠ê Become Member</button>
            <% } %>
            <form method="POST" action="/logout" style="display: inline;">
                <button type="submit" class="secondary outline">üö™ Logout</button>
            </form>
        </div>
        
        <!-- Messages List -->
        <article>
            <% if (messages && messages.length > 0) { %>
                <% messages.forEach(msg => { %>
                    <div class="message-item <%= msg.user_id === user.id ? 'own-message' : '' %>">
                        <!-- Username -->
                        <% if (user.ismember || msg.user_id === user.id || user.isadmin) { %>
                            <strong><%= msg.username %></strong>
                        <% } else { %>  
                            <strong>Anonymous</strong>
                        <% } %>
                        
                        <!-- Actions -->
                        <span class="message-actions">
                            <% if (msg.canEdit) { %>
                                <button onclick="openEditModal(<%= msg.id %>, '<%= msg.message.replace(/'/g, "\\'").replace(/\n/g, '\\n') %>')" class="outline secondary">
                                    ‚úèÔ∏è
                                </button>
                            <% } %>
                            <% if (msg.canDelete) { %>
                                <form method="POST" action="/messages/<%= msg.id %>/delete" style="display:inline;">
                                    <button type="submit" class="outline secondary" onclick="return confirm('Delete this message?')">üóëÔ∏è</button>
                                </form>
                            <% } %>
                        </span>
                        
                        <!-- Message Content -->
                        <p style="margin: 0.5rem 0 0 0;">
                            <%= msg.message %>
                        </p>
                        
                        <!-- Metadata -->
                        <div class="message-meta">
                            <%= new Date(msg.created_at).toLocaleString() %>
                            <% if (msg.edited_at) { %>
                                ¬∑ <em>edited</em>
                            <% } %>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <p><em>No messages yet. Be the first to say something!</em></p>
            <% } %>
        </article>
        
        <!-- New Message Form -->
        <article>
            <form method="POST" action="/messages">
                <label>
                    New Message
                    <textarea name="message" placeholder="Type your message..." required rows="3"></textarea>
                </label>
                <button type="submit">üì§ Send Message</button>
            </form>
        </article>
    </main>
    
    <!-- ========== MODAL 1: Edit Message ========== -->
    <dialog id="editMessageModal">
        <article>
            <header>
                <button aria-label="Close" rel="prev" onclick="closeEditModal()"></button>
                <h3>Edit Message</h3>
            </header>
            <form id="editMessageForm" method="POST">
                <label>
                    Message
                    <textarea id="editMessageText" name="message" required rows="5"></textarea>
                </label>
                <footer>
                    <button type="button" onclick="closeEditModal()" class="secondary">Cancel</button>
                    <button type="submit">üíæ Save</button>
                </footer>
            </form>
        </article>
    </dialog>
    
    <!-- ========== MODAL 2: User Management ========== -->
    <dialog id="userModal">
        <article>
            <header>
                <button aria-label="Close" rel="prev" onclick="closeUserModal()"></button>
                <h3>Users List</h3>
            </header>
            
            <figure>
                <table role="grid">
                    <thead>
                        <tr>
                            <th scope="col">Username</th>
                            <% if (canSeeDetails) { %>
                                <th scope="col">Status</th>
                                <th scope="col">Messages</th>
                            <% } %>
                            <% if (canManageUsers) { %>
                                <th scope="col">Actions</th>
                            <% } %>
                        </tr>
                    </thead>
                    <tbody>
                        <% allUsers.forEach(u => { %>
                            <%
                            const showRealName = canSeeDetails || u.id === user.id;
                            const canModifyThisUser = canManageUsers && !u.isadmin && u.id !== user.id;
                            %>
                            <tr>
                                <td><%= showRealName ? u.username : 'Anonymous' %></td>
                                
                                <% if (canSeeDetails) { %>
                                    <td>
                                        <% if (u.isadmin) { %>
                                            <span role="button" style="--pico-color: var(--pico-del-color); padding: 0.25rem 0.5rem; font-size: 0.75rem;">Admin</span>
                                        <% } else if (u.ismember) { %>
                                            <span role="button" style="--pico-color: var(--pico-ins-color); padding: 0.25rem 0.5rem; font-size: 0.75rem;">Member</span>
                                        <% } else { %>
                                            <span style="color: var(--pico-muted-color);">User</span>
                                        <% } %>
                                    </td>
                                    <td><%= u.message_count %></td>
                                <% } %>
                                
                                <% if (canManageUsers) { %>
                                    <td>
                                        <% if (canModifyThisUser) { %>
                                            <div style="display: flex; gap: 0.25rem;">
                                                <% if (u.ismember) { %>
                                                    <form method="POST" action="/users/<%= u.id %>/demote">
                                                        <button type="submit" class="outline secondary">‚¨áÔ∏è</button>
                                                    </form>
                                                <% } else { %>
                                                    <form method="POST" action="/users/<%= u.id %>/promote">
                                                        <button type="submit" class="outline">‚¨ÜÔ∏è</button>
                                                    </form>
                                                <% } %>
                                                <form method="POST" action="/users/<%= u.id %>/kick"
                                                      onsubmit="return confirm('Kick <%= u.username %>?')">
                                                    <button type="submit" class="outline" style="--pico-color: var(--pico-del-color);">üö´</button>
                                                </form>
                                            </div>
                                        <% } else if (u.id === user.id) { %>
                                            <small style="color: var(--pico-muted-color);">You</small>
                                        <% } %>
                                    </td>
                                <% } %>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </figure>
            
            <footer>
                <button onclick="closeUserModal()" class="secondary">Close</button>
            </footer>
        </article>
    </dialog>
    
    <!-- ========== MODAL 3: Become Member ========== -->
    <% if (user && !user.ismember) { %>
        <dialog id="memberModal">
            <article>
                <header>
                    <button aria-label="Close" rel="prev" onclick="closeMemberModal()"></button>
                    <h3>üéØ Become a Member</h3>
                </header>
                
                <p style="background: var(--pico-card-background-color); padding: 1rem; border-radius: var(--pico-border-radius);">
                    <strong>ü§î Puzzle:</strong><br>
                    What comes first, the chicken or the...?
                </p>
                
                <form method="POST" action="/becomeMember">
                    <label>
                        Your Answer
                        <input 
                            type="text" 
                            name="answer" 
                            placeholder="Type your answer..." 
                            required 
                            autocomplete="off"
                        />
                    </label>
                    <footer>
                        <button type="button" onclick="closeMemberModal()" class="secondary">Cancel</button>
                        <button type="submit">Submit Answer</button>
                    </footer>
                </form>
            </article>
        </dialog>
    <% } %>
    
    <!-- ========== JAVASCRIPT ========== -->
    <script>
        // Modal functions
        function openEditModal(messageId, currentText) {
            document.getElementById('editMessageText').value = currentText;
            document.getElementById('editMessageForm').action = `/messages/${messageId}/edit`;
            document.getElementById('editMessageModal').showModal();
        }
        
        function closeEditModal() {
            document.getElementById('editMessageModal').close();
        }
        
        function openUserModal() {
            document.getElementById('userModal').showModal();
        }
        
        function closeUserModal() {
            document.getElementById('userModal').close();
            if (window.location.hash === '#open-users-modal') {
                history.pushState("", document.title, window.location.pathname);
            }
        }
        
        function openMemberModal() {
            document.getElementById('memberModal')?.showModal();
        }
        
        function closeMemberModal() {
            document.getElementById('memberModal')?.close();
        }
        
        // Auto-open modals
        window.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash;
            if (hash === '#open-users-modal') {
                openUserModal();
                history.replaceState(null, null, ' ');
            }
            <% if (messages.error && user && !user.ismember) { %>
                openMemberModal();
            <% } %>
        });
        
        // Close on outside click
        document.querySelectorAll('dialog').forEach(dialog => {
            dialog.addEventListener('click', function(event) {
                if (event.target === this) {
                    this.close();
                }
            });
        });
    </script>
</body>
</html>
